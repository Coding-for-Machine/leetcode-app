{% extends "base.html" %}

{% block title %}
Contest
{% endblock title %}


{% block contest %}
<style>
    .progress-bar {
        transition: width 0.5s ease-in-out;
    }
</style>

<script>

    document.addEventListener('DOMContentLoaded', function() {
        const userId = 1; // Foydalanuvchi ID (real loyihada auth orqali olinadi)
        
        // Kelgusi tanlovlarni yuklash
        loadUpcomingContests();
        
        // O'tgan tanlovlarni yuklash
        loadPastContests();
        
        // Foydalanuvchi statistikasini yuklash
        loadUserStats(userId);
        
        // Ro'yxatdan o'tish tugmalari uchun hodisalar
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('contest-register-btn')) {
                registerForContest(e.target.dataset.contestId);
            }
        });
    });
    
    // Kelgusi tanlovlarni yuklash
    async function loadUpcomingContests() {
        try {
            const response = await fetch('/api/contests/upcoming/');
            if (!response.ok) throw new Error('Network response was not ok');
            
            const contests = await response.json();
            const container = document.querySelector('.space-y-4');
            
            // Avvalgi kartalarni tozalash
            container.innerHTML = '';
            
            // Yangi kartalarni qo'shish
            contests.forEach(contest => {
                const card = createContestCard(contest);
                container.insertAdjacentHTML('beforeend', card);
            });
        } catch (error) {
            console.error('Error loading upcoming contests:', error);
            showAlert('error', 'Tanlovlarni yuklashda xatolik yuz berdi');
        }
    }
    
    // O'tgan tanlovlarni yuklash
    async function loadPastContests() {
        try {
            const response = await fetch('/api/contests/past/');
            if (!response.ok) throw new Error('Network response was not ok');
            
            const contests = await response.json();
            const tbody = document.querySelector('tbody');
            
            // Avvalgi jadvalni tozalash
            tbody.innerHTML = '';
            
            // Yangi qatorlarni qo'shish
            contests.forEach(contest => {
                const row = createPastContestRow(contest);
                tbody.insertAdjacentHTML('beforeend', row);
            });
        } catch (error) {
            console.error('Error loading past contests:', error);
            showAlert('error', 'O\'tgan tanlovlarni yuklashda xatolik');
        }
    }
    
    // Foydalanuvchi statistikasini yuklash
    async function loadUserStats(userId) {
        try {
            const response = await fetch(`/api/contests/stats/${userId}/`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const stats = await response.json();
            
            // Statistikani yangilash
            document.querySelectorAll('.stat-value.total-contests').forEach(el => {
                el.textContent = stats.total_contests;
            });
            
            document.querySelectorAll('.stat-value.best-rank').forEach(el => {
                el.textContent = stats.best_rank || '-';
            });
            
            document.querySelectorAll('.stat-value.average-rank').forEach(el => {
                el.textContent = stats.average_rank ? stats.average_rank.toFixed(1) : '-';
            });
            
            document.querySelectorAll('.stat-value.total-points').forEach(el => {
                el.textContent = stats.total_points;
            });
            
            // Progress barlarni yangilash
            updateProgressBar('contests-progress', stats.total_contests / 50 * 100);
            updateProgressBar('rank-progress', stats.best_rank ? (1 / stats.best_rank) * 100 : 0);
            updateProgressBar('points-progress', stats.total_points / 50000 * 100);
        } catch (error) {
            console.error('Error loading user stats:', error);
        }
    }
    
    // Tanlov kartasini yaratish
    function createContestCard(contest) {
        return `
            <div class="contest-card card-hover bg-white rounded-lg p-5" data-contest-id="${contest.id}">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-3 md:mb-0">
                        <h3 class="font-bold text-lg mb-1">${contest.title}</h3>
                        <div class="flex items-center text-sm text-slate-600">
                            <i class="fas fa-clock mr-2"></i>
                            <span>${formatDate(contest.start_time)} | ${contest.duration} daqiqa</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            ${contest.duration} daqiqa
                        </span>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                            ${contest.problem_count} masala
                        </span>
                    </div>
                </div>
                <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between contest-card-content">
                    <div class="flex items-center mb-2 md:mb-0">
                        <div class="relative w-16 h-16 mr-3">
                            <svg class="w-full h-full" viewBox="0 0 36 36">
                                <circle cx="18" cy="18" r="16" fill="none" stroke="#e2e8f0" stroke-width="2"></circle>
                                <circle cx="18" cy="18" r="16" fill="none" stroke="#6366f1" stroke-width="2" 
                                    stroke-dasharray="100" stroke-dashoffset="${100 - contest.progress}"></circle>
                                <text x="18" y="20.5" text-anchor="middle" font-size="10" fill="#6366f1" font-weight="bold">
                                    ${contest.progress}%
                                </text>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-slate-600">Ro'yxatdan o'tganlar</p>
                            <p class="text-sm font-medium">${contest.registered_participants} ishtirokchi</p>
                        </div>
                    </div>
                    <button class="gradient-btn hover:bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium shadow-sm contest-register-btn"
                        data-contest-id="${contest.id}">
                        Ro'yxatdan o'tish
                    </button>
                </div>
            </div>
        `;
    }
    
    // O'tgan tanlov qatorini yaratish
    function createPastContestRow(contest) {
        return `
            <tr class="hover:bg-slate-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="font-medium">${contest.title}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                    ${formatDate(contest.start_time)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                        ${contest.problem_count}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    #${contest.user_rank || '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">
                    ${contest.user_score || '0'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="/contests/${contest.id}/results/" class="text-indigo-600 hover:text-indigo-800">Natijalar</a>
                </td>
            </tr>
        `;
    }
    
    // Ro'yxatdan o'tish funksiyasi
    async function registerForContest(contestId) {
        try {
            const response = await fetch('/api/contests/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    contest_id: contestId,
                    user_id: 1 // Foydalanuvchi ID
                })
            });
            
            if (response.ok) {
                showAlert('success', 'Muvaffaqiyatli ro\'yxatdan o\'tdingiz!');
                // Ro'yxatdan o'tish tugmasini yangilash
                document.querySelector(`.contest-register-btn[data-contest-id="${contestId}"]`)
                    .textContent = 'Ro\'yxatdan o\'tilgan';
            } else {
                const error = await response.json();
                showAlert('error', error.message || 'Xatolik yuz berdi');
            }
        } catch (error) {
            console.error('Registration error:', error);
            showAlert('error', 'Tarmoq xatosi. Iltimos, qayta urunib ko\'ring.');
        }
    }
    
    // Yordamchi funksiyalar
    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('uz-UZ', options);
    }
    
    function updateProgressBar(elementId, percent) {
        const bar = document.getElementById(elementId);
        if (bar) {
            bar.style.width = `${Math.min(100, percent)}%`;
        }
    }
    
    function getCookie(name) {
        // ... cookie olish funksiyasi ...
    }
    
    function showAlert(type, message) {
        // Xabarnoma ko'rsatish funksiyasi
        const alertDiv = document.createElement('div');
        alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg ${
            type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
        }`;
        alertDiv.textContent = message;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>
{% endblock contest %}




